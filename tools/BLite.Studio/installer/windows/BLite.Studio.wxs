<?xml version="1.0" encoding="UTF-8"?>
<!--
  BLite Studio — WiX 6 MSI definition
  Build with (SourceDir must be an absolute path):
    wix build BLite.Studio.wxs \
        -d AppVersion=1.0.0     \
        "-d SourceDir=C:\path\to\publish\win-x64" \
        -arch x64               \
        -ext WixToolset.UI.wixext \
        -o BLite.Studio-1.0.0-win-x64.msi
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="BLite Studio"
           Manufacturer="BLite Project"
           Version="$(AppVersion)"
           Language="1033"
           UpgradeCode="3A7F2E14-9C6B-4D58-A021-5E8BF301C742"
           Compressed="yes">

    <SummaryInformation
        Keywords="BLite Studio database explorer installer"
        Description="BLite Studio v$(AppVersion)"
        Manufacturer="BLite Project" />

    <!-- Remove old version before installing new one -->
    <MajorUpgrade
        Schedule="afterInstallInitialize"
        DowngradeErrorMessage="A newer version of BLite Studio is already installed. Please uninstall it first." />

    <MediaTemplate EmbedCab="yes" />

    <!-- ── UI: feature tree (shows optional shortcuts) + license ── -->
    <ui:WixUI Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="$(LicenseRtf)" />

    <!-- "Launch BLite Studio" checkbox on the final dialog -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch BLite Studio" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

    <!-- Set LAUNCHAPP at runtime (after dirs are resolved) then exec async -->
    <SetProperty Id="LAUNCHAPP"
                 Value="[INSTALLFOLDER]BLite.Studio.exe"
                 Before="LaunchApplication"
                 Sequence="execute" />
    <CustomAction Id="LaunchApplication"
                  Property="LAUNCHAPP"
                  ExeCommand=""
                  Execute="immediate"
                  Impersonate="yes"
                  Return="asyncNoWait" />

    <InstallExecuteSequence>
      <Custom Action="LaunchApplication"
              After="InstallFinalize"
              Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed" />
    </InstallExecuteSequence>

    <!-- ── Directories ─────────────────────────────────────── -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="BLite Studio" />
    </StandardDirectory>

    <!-- All published files (exe + DLLs + assets) -->
    <ComponentGroup Id="SupportFilesGroup" Directory="INSTALLFOLDER">
      <Files Include="$(SourceDir)\**" />
    </ComponentGroup>

    <!-- Start Menu shortcut -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="BLite Studio">
        <Component Id="StartMenuShortcut" Guid="*">
          <Shortcut Id="StartMenuLink"
                    Name="BLite Studio"
                    Description="BLite database explorer"
                    Target="[INSTALLFOLDER]BLite.Studio.exe"
                    WorkingDirectory="INSTALLFOLDER" />
          <RemoveFolder Id="RemoveStartMenuFolder"
                        Directory="ApplicationProgramsFolder"
                        On="uninstall" />
          <RegistryValue Root="HKCU"
                         Key="Software\BLiteProject\Studio"
                         Name="StartMenu"
                         Type="integer" Value="1"
                         KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Desktop shortcut -->
    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut Id="DesktopLink"
                  Name="BLite Studio"
                  Description="BLite database explorer"
                  Target="[INSTALLFOLDER]BLite.Studio.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RegistryValue Root="HKCU"
                       Key="Software\BLiteProject\Studio"
                       Name="Desktop"
                       Type="integer" Value="1"
                       KeyPath="yes" />
      </Component>
    </StandardDirectory>

    <!-- ── Feature tree ────────────────────────────────────── -->
    <Feature Id="ProductFeature"
             Title="BLite Studio"
             Description="The BLite Studio application."
             Level="1"
             Display="expand">

      <ComponentGroupRef Id="SupportFilesGroup" />

      <Feature Id="StartMenuFeature"
               Title="Start Menu shortcut"
               Description="Create a shortcut in the Start Menu."
               Level="1">
        <ComponentRef Id="StartMenuShortcut" />
      </Feature>

      <Feature Id="DesktopFeature"
               Title="Desktop shortcut"
               Description="Create a shortcut on the Desktop."
               Level="1">
        <ComponentRef Id="DesktopShortcut" />
      </Feature>

    </Feature>

  </Package>
</Wix>