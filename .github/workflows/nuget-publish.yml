# Nome del workflow visualizzato su GitHub
name: Publish to NuGet

# --- Trigger ---
# Elenco degli eventi che attivano questo workflow
on:
  push:
    branches:
      - main # Si attiva a ogni push sul branch 'main'
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Si attiva quando viene pushato un tag come 'v1.0.0'
  pull_request:
    branches:
      - main # Si attiva quando viene aperta/aggiornata una PR verso 'main'
  workflow_dispatch: # Permette di avviare il workflow manualmente dalla UI di GitHub

jobs:
  build_and_publish:
    # SPECIFICA L'AMBIENTE PER ACCEDERE AI SEGRETI CORRISPONDENTI
    environment: Production
    runs-on: ubuntu-latest
    
    # AGGIUNGE I PERMESSI NECESSARI PER CREARE UNA RELEASE
    permissions:
      contents: write

    steps:
      # 1. Scarica il codice del repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensure we get tags for versioning

      # 2. Installa la versione specificata di .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 3. Ripristina le dipendenze NuGet del progetto
      - name: Restore dependencies
        run: dotnet restore

      # 4. Compila i progetti in configurazione Release
      - name: Build BLite.Bson
        run: dotnet build src/BLite.Bson/BLite.Bson.csproj --no-restore --configuration Release
      
      - name: Build BLite.Core
        run: dotnet build src/BLite.Core/BLite.Core.csproj --no-restore --configuration Release
      
      - name: Build BLite.SourceGenerators
        run: dotnet build src/BLite.SourceGenerators/BLite.SourceGenerators.csproj --no-restore --configuration Release
      
      - name: Build BLite
        run: dotnet build src/BLite/BLite.csproj --no-restore --configuration Release
      
      - name: Build Tests
        run: dotnet build tests/BLite.Tests/BLite.Tests.csproj --no-restore --configuration Release

      # 5. Esegui i test
      - name: Test
        run: dotnet test tests/BLite.Tests/BLite.Tests.csproj --no-build --configuration Release

      # --- Pubblicazione ---
      # I seguenti passaggi vengono eseguiti SOLO se il workflow
      # Ã¨ stato attivato dal push di un tag (es. v1.2.3)

      # 6. Crea i pacchetti NuGet per i progetti pacchettizzabili
      - name: Pack projects
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          dotnet pack src/BLite.Bson/BLite.Bson.csproj --no-build --configuration Release --output ./packages
          dotnet pack src/BLite.Core/BLite.Core.csproj --no-build --configuration Release --output ./packages
          dotnet pack src/BLite.SourceGenerators/BLite.SourceGenerators.csproj --no-build --configuration Release --output ./packages
          dotnet pack src/BLite/BLite.csproj --no-build --configuration Release --output ./packages

      # 7. Pubblica tutti i pacchetti .nupkg creati nel passo precedente
      - name: Publish to NuGet
        if: startsWith(github.ref, 'refs/tags/v')
        run: dotnet nuget push "./packages/*.nupkg" --api-key "${{ secrets.NUGET_API_KEY }}" --source https://api.nuget.org/v3/index.json

      # 8. Estrae le note di rilascio dal CHANGELOG.md per la versione corrente
      - name: Extract Release Notes
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          awk -v ver="$VERSION" '
            BEGIN { p=0 }
            $0 ~ "^<a name=\"" ver "\">" { p=1; next }
            p==1 && /^<a name=/ { p=0 }
            p==1 { print }
          ' CHANGELOG.md > RELEASE_NOTES.md

      # 9. Crea una Release su GitHub e carica i pacchetti come artefatti
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ./packages/*.nupkg
          # Usa solo le note specifiche della versione estratte nel passo precedente
          body_path: RELEASE_NOTES.md
